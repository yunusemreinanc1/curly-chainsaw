name: RDP

on:
  workflow_dispatch:

jobs:
  secure-rdp:
    runs-on: windows-latest
    timeout-minutes: 3600

    steps:
      - name: Configure Core RDP Settings
        run: |
          # Enable Remote Desktop and disable Network Level Authentication (if needed)
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' `
                             -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
                             -Name "UserAuthentication" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
                             -Name "SecurityLayer" -Value 0 -Force

          # Remove any existing rule with the same name to avoid duplication
          netsh advfirewall firewall delete rule name="RDP-Tailscale" 2>$null
          
          # For testing, allow any incoming connection on port 3389
          netsh advfirewall firewall add rule name="RDP-Tailscale" `
            dir=in action=allow protocol=TCP localport=3389

          # (Optional) Restart the Remote Desktop service to ensure changes take effect
          Restart-Service -Name TermService -Force
          Write-Host "‚úÖ RDP Core settings configured!"

      - name: Enable Virtualization Features for BlueStacks
        run: |
          Write-Host "üîß Configuring virtualization for BlueStacks..."
          
          # Windows Server 2022 compatible virtualization features
          try {
              Enable-WindowsOptionalFeature -Online -FeatureName HypervisorPlatform -All -NoRestart -ErrorAction SilentlyContinue
              Write-Host "‚úÖ Windows Hypervisor Platform enabled"
          } catch {
              Write-Host "‚ö†Ô∏è Hypervisor Platform not available, proceeding without it"
          }
          
          # Enable Virtual Machine Platform
          try {
              Enable-WindowsOptionalFeature -Online -FeatureName VirtualMachinePlatform -All -NoRestart -ErrorAction SilentlyContinue
              Write-Host "‚úÖ Virtual Machine Platform enabled"
          } catch {
              Write-Host "‚ö†Ô∏è VM Platform not available, proceeding without it"
          }
          
          # Enable Windows Subsystem for Linux (helps with virtualization)
          try {
              Enable-WindowsOptionalFeature -Online -FeatureName Microsoft-Windows-Subsystem-Linux -NoRestart -ErrorAction SilentlyContinue
              Write-Host "‚úÖ WSL enabled for better virtualization support"
          } catch {
              Write-Host "‚ö†Ô∏è WSL not available, proceeding without it"
          }
          
          Write-Host "üîß Virtualization features configured for BlueStacks!"

      - name: Optimize RDP Performance (GPU + 60FPS + Android Emulation)
        run: |
          Write-Host "‚ö° Optimizing RDP for gaming and Android emulation..."
          
          # Enable GPU acceleration for RDP
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
                           -Name "fEnableWinStation" -Value 1 -Force
          
          # Enable hardware graphics acceleration
          New-Item -Path 'HKLM:\Software\Policies\Microsoft\Windows NT\Terminal Services' -Force | Out-Null
          Set-ItemProperty -Path 'HKLM:\Software\Policies\Microsoft\Windows NT\Terminal Services' `
                           -Name "fEnableVirtualizedGraphics" -Value 1 -Force
          
          # Set maximum color depth (32-bit)
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
                           -Name "ColorDepth" -Value 4 -Force
          
          # Disable compression for better quality (60FPS support)
          Set-ItemProperty -Path 'HKLM:\Software\Policies\Microsoft\Windows NT\Terminal Services' `
                           -Name "MaxCompressionLevel" -Value 0 -Force
          
          # Enable H.264/AVC hardware encoding
          Set-ItemProperty -Path 'HKLM:\Software\Policies\Microsoft\Windows NT\Terminal Services' `
                           -Name "AVC444ModePreferred" -Value 1 -Force
          Set-ItemProperty -Path 'HKLM:\Software\Policies\Microsoft\Windows NT\Terminal Services' `
                           -Name "AVCHardwareEncodePreferred" -Value 1 -Force
          
          # Optimize for Android emulation and gaming
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
                           -Name "fAutoClientLpts" -Value 1 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
                           -Name "fAutoClientDrives" -Value 1 -Force
          
          # Disable desktop composition for better gaming performance
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
                           -Name "fDisableCdm" -Value 0 -Force
          
          Write-Host "‚úÖ RDP optimized for 60FPS gaming + Android emulation!"

      - name: Create RDP User with Secure Password
        run: |
          Write-Host "üë§ Creating secure RDP user..."
          
          Add-Type -AssemblyName System.Security
          $charSet = @{
              Upper   = [char[]](65..90)      # A-Z
              Lower   = [char[]](97..122)     # a-z
              Number  = [char[]](48..57)      # 0-9
              Special = ([char[]](33..47) + [char[]](58..64) +
                         [char[]](91..96) + [char[]](123..126)) # Special characters
          }
          $rawPassword = @()
          $rawPassword += $charSet.Upper | Get-Random -Count 4
          $rawPassword += $charSet.Lower | Get-Random -Count 4
          $rawPassword += $charSet.Number | Get-Random -Count 4
          $rawPassword += $charSet.Special | Get-Random -Count 4
          $password = -join ($rawPassword | Sort-Object { Get-Random })
          $securePass = ConvertTo-SecureString $password -AsPlainText -Force
          
          try {
              New-LocalUser -Name "RDP" -Password $securePass -AccountNeverExpires -ErrorAction Stop
              Add-LocalGroupMember -Group "Administrators" -Member "RDP" -ErrorAction Stop
              Add-LocalGroupMember -Group "Remote Desktop Users" -Member "RDP" -ErrorAction Stop
              Write-Host "‚úÖ RDP user created successfully!"
          } catch {
              Write-Host "‚ö†Ô∏è User might already exist, attempting to update password..."
              Set-LocalUser -Name "RDP" -Password $securePass
          }
          
          echo "RDP_PASSWORD=$password" >> $env:GITHUB_ENV
          
          if (-not (Get-LocalUser -Name "RDP" -ErrorAction SilentlyContinue)) {
              Write-Error "‚ùå User creation failed"
              exit 1
          }

      - name: Install BlueStacks 5 (Server 2022 Compatible)
        run: |
          Write-Host "üéÆ Installing BlueStacks 5 for mobile gaming..."
          
          # Install Chocolatey first (most reliable method)
          Write-Host "üì¶ Setting up Chocolatey package manager..."
          Set-ExecutionPolicy Bypass -Scope Process -Force
          [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072
          try {
              Invoke-Expression ((New-Object System.Net.WebClient).DownloadString('https://chocolatey.org/install.ps1'))
              Write-Host "‚úÖ Chocolatey installed"
          } catch {
              Write-Host "‚ö†Ô∏è Chocolatey installation issue, trying direct BlueStacks download..."
          }
          
          # Method 1: Try Chocolatey installation (most reliable for Server 2022)
          $bluestacksInstalled = $false
          try {
              Write-Host "üì± Installing BlueStacks via Chocolatey..."
              choco install bluestacks5 -y --ignore-checksums --no-progress --timeout 600
              $bluestacksInstalled = $true
              Write-Host "‚úÖ BlueStacks installed via Chocolatey"
          } catch {
              Write-Host "‚ö†Ô∏è Chocolatey installation failed, trying direct download..."
          }
          
          # Method 2: Direct download if Chocolatey failed
          if (-not $bluestacksInstalled) {
              $bluestacksUrl = "https://cdn3.bluestacks.com/downloads/windows/bgp64_mac/5.21.610.1002/9f8613b0f2b647b8a7c27e0474d5c55c/x64/BlueStacksInstaller_5.21.610.1002_amd64_native.exe"
              $installerPath = "$env:TEMP\BlueStacksInstaller.exe"
              
              Write-Host "‚¨áÔ∏è Downloading BlueStacks installer..."
              try {
                  Invoke-WebRequest -Uri $bluestacksUrl -OutFile $installerPath -UseBasicParsing -TimeoutSec 300
                  Write-Host "‚úÖ Download completed"
                  
                  Write-Host "üì¶ Installing BlueStacks..."
                  $installArgs = @("-s", "--defaultImageName", "Nougat64", "--imageToLaunch", "Nougat64")
                  Start-Process -FilePath $installerPath -ArgumentList $installArgs -Wait -NoNewWindow
                  Remove-Item $installerPath -Force -ErrorAction SilentlyContinue
                  $bluestacksInstalled = $true
                  Write-Host "‚úÖ BlueStacks direct installation completed"
              } catch {
                  Write-Host "‚ùå Direct installation failed: $($_.Exception.Message)"
              }
          }
          
          # Install essential gaming tools
          Write-Host "üõ†Ô∏è Installing gaming essentials..."
          try {
              choco install googlechrome 7zip notepadplusplus -y --no-progress
              Write-Host "‚úÖ Gaming tools installed"
          } catch {
              Write-Host "‚ö†Ô∏è Some tools failed to install, but core functionality should work"
          }
          
          # Verify and configure BlueStacks
          $bluestacksPaths = @(
              "C:\Program Files\BlueStacks_nxt",
              "C:\Program Files (x86)\BlueStacks_nxt",
              "C:\ProgramData\BlueStacks_nxt"
          )
          
          $installed = $false
          foreach ($path in $bluestacksPaths) {
              if (Test-Path $path) {
                  Write-Host "‚úÖ BlueStacks found at: $path"
                  $installed = $true
                  
                  # Configure for optimal performance
                  $configPath = "$env:PROGRAMDATA\BlueStacks_nxt\bluestacks.conf"
                  if (Test-Path $configPath) {
                      Write-Host "‚ö° Optimizing BlueStacks performance..."
                      try {
                          $content = Get-Content $configPath -ErrorAction SilentlyContinue
                          $content = $content -replace 'bst.instance.Nougat64.memory=.*', 'bst.instance.Nougat64.memory=3072'
                          $content = $content -replace 'bst.instance.Nougat64.cpu_count=.*', 'bst.instance.Nougat64.cpu_count=2'
                          $content | Set-Content $configPath
                          Write-Host "‚úÖ BlueStacks performance optimized (3GB RAM, 2 CPU cores)"
                      } catch {
                          Write-Host "‚ö†Ô∏è Config optimization skipped, using defaults"
                      }
                  }
                  break
              }
          }
          
          if ($installed) {
              Write-Host "üéÆ BlueStacks setup completed successfully!"
              echo "BLUESTACKS_INSTALLED=true" >> $env:GITHUB_ENV
          } else {
              Write-Host "‚ö†Ô∏è BlueStacks installation verification failed"
              Write-Host "üîÑ You can try installing manually via RDP if needed"
              echo "BLUESTACKS_INSTALLED=false" >> $env:GITHUB_ENV
          }

      - name: Install Tailscale
        run: |
          Write-Host "üåê Installing Tailscale..."
          $tsUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-1.82.0-amd64.msi"
          $installerPath = "$env:TEMP\tailscale.msi"
          
          try {
              Invoke-WebRequest -Uri $tsUrl -OutFile $installerPath -TimeoutSec 120
              Start-Process msiexec.exe -ArgumentList "/i", "`"$installerPath`"", "/quiet", "/norestart" -Wait
              Remove-Item $installerPath -Force -ErrorAction SilentlyContinue
              Write-Host "‚úÖ Tailscale installed successfully!"
          } catch {
              Write-Error "‚ùå Tailscale installation failed: $($_.Exception.Message)"
              exit 1
          }

      - name: Establish Tailscale Connection
        run: |
          Write-Host "üîó Connecting to Tailscale network..."
          
          # Bring up Tailscale with the provided auth key and set a unique hostname
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=gh-runner-$env:GITHUB_RUN_ID
          
          # Wait for Tailscale to assign an IP
          $tsIP = $null
          $retries = 0
          while (-not $tsIP -and $retries -lt 15) {
              Start-Sleep -Seconds 3
              try {
                  $tsIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
                  if ($tsIP -and $tsIP.Trim() -ne "") {
                      break
                  }
              } catch {
                  Write-Host "‚è≥ Waiting for Tailscale IP assignment... (attempt $($retries + 1))"
              }
              $retries++
          }
          
          if (-not $tsIP -or $tsIP.Trim() -eq "") {
              Write-Error "‚ùå Tailscale IP not assigned after 45 seconds. Check your auth key."
              exit 1
          }
          
          $tsIP = $tsIP.Trim()
          echo "TAILSCALE_IP=$tsIP" >> $env:GITHUB_ENV
          Write-Host "‚úÖ Tailscale connected with IP: $tsIP"
      
      - name: Verify RDP Accessibility & Start BlueStacks
        run: |
          Write-Host "üîç Verifying RDP connectivity..."
          Write-Host "Tailscale IP: $env:TAILSCALE_IP"
          
          # Test connectivity using Test-NetConnection against the Tailscale IP on port 3389
          $testResult = Test-NetConnection -ComputerName $env:TAILSCALE_IP -Port 3389 -WarningAction SilentlyContinue
          if (-not $testResult.TcpTestSucceeded) {
              Write-Error "‚ùå TCP connection to RDP port 3389 failed"
              exit 1
          }
          Write-Host "‚úÖ RDP connectivity verified!"
          
          # Attempt to start BlueStacks if installed
          if ($env:BLUESTACKS_INSTALLED -eq "true") {
              Write-Host "üöÄ Attempting to start BlueStacks..."
              $bluestacksExes = @(
                  "C:\Program Files\BlueStacks_nxt\HD-Player.exe",
                  "C:\Program Files (x86)\BlueStacks_nxt\HD-Player.exe",
                  "C:\ProgramData\BlueStacks_nxt\HD-Player.exe"
              )
              
              $started = $false
              foreach ($exe in $bluestacksExes) {
                  if (Test-Path $exe) {
                      try {
                          Start-Process $exe -WindowStyle Minimized -ErrorAction Stop
                          Write-Host "‚úÖ BlueStacks started successfully!"
                          $started = $true
                          break
                      } catch {
                          Write-Host "‚ö†Ô∏è Could not auto-start BlueStacks: $($_.Exception.Message)"
                      }
                  }
              }
              
              if (-not $started) {
                  Write-Host "‚ö†Ô∏è BlueStacks auto-start failed, but you can launch it manually via RDP"
              }
          }

      - name: Send RDP + BlueStacks Details to Telegram
        run: |
          $botToken = "${{ secrets.TELEGRAM_BOT_TOKEN }}"
          $chatId = "${{ secrets.TELEGRAM_CHAT_ID }}"
          
          if ($botToken -and $chatId) {
              $runId = "$env:GITHUB_RUN_ID"
              $repoName = "${{ github.repository }}"
              $currentTime = Get-Date -Format "yyyy-MM-dd HH:mm:ss UTC"
              $bluestacksStatus = if ($env:BLUESTACKS_INSTALLED -eq "true") { "‚úÖ Ready" } else { "‚ö†Ô∏è Manual Install Required" }
              
              $message = "üéÆ **RDP + BlueStacks Server Ready!**`n`n" +
                        "üåê **IP:** ``$env:TAILSCALE_IP```
                        "üë§ **User:** ``RDP```n" +
                        "üîë **Pass:** ``$env:RDP_PASSWORD```
                        "üöÄ **Features:**`n" +
                        "üì± BlueStacks 5: $bluestacksStatus`n" +
                        "‚ö° 60FPS + GPU Acceleration`n" +
                        "üñ•Ô∏è Windows Server 2022`n" +
                        "üîß Optimized for Mobile Gaming`n`n" +
                        "üéØ **Perfect for:**`n" +
                        "-  Free Fire Gaming`n" +
                        "-  GameGuardian Scripts`n" +
                        "-  Mobile App Development`n" +
                        "-  Android Automation`n`n" +
                        "üõ†Ô∏è **Repository:** $repoName`n" +
                        "üÜî **Run ID:** $runId`n" +
                        "‚è∞ **Started:** $currentTime`n`n" +
                        "üî• **Ready for mobile game automation!**"
              
              try {
                  $body = @{
                      chat_id = $chatId
                      text = $message
                      parse_mode = "Markdown"
                      disable_web_page_preview = $true
                  } | ConvertTo-Json -Depth 10
                  
                  $response = Invoke-RestMethod -Uri "https://api.telegram.org/bot$botToken/sendMessage" `
                                              -Method POST `
                                              -ContentType "application/json" `
                                              -Body $body
                  
                  Write-Host "‚úÖ RDP + BlueStacks details sent to Telegram!"
              }
              catch {
                  Write-Host "‚ùå Failed to send Telegram notification: $($_.Exception.Message)"
                  Write-Host "‚ö†Ô∏è Continuing without notification..."
              }
          }
          else {
              Write-Host "‚ö†Ô∏è Telegram credentials not configured. Add TELEGRAM_BOT_TOKEN and TELEGRAM_CHAT_ID secrets."
          }

      - name: Maintain Connection
        run: |
          Write-Host "`n"
          Write-Host "========================================="
          Write-Host "üéÆ RDP + BLUESTACKS SERVER READY!"
          Write-Host "========================================="
          Write-Host "üåê Address: $env:TAILSCALE_IP"
          Write-Host "üë§ Username: RDP"
          Write-Host "üîë Password: $env:RDP_PASSWORD"
          Write-Host "üì± BlueStacks: $($env:BLUESTACKS_INSTALLED)"
          Write-Host "üöÄ Features: 60FPS + GPU + Android Emulation"
          Write-Host "üéØ Perfect for: Free Fire, GameGuardian, Mobile Gaming"
          Write-Host "========================================="
          Write-Host ""
          
          # Keep runner active with status updates
          $counter = 0
          while ($true) {
              $counter++
              $uptime = [math]::Round(($counter * 5) / 60, 1)
              Write-Host "[$(Get-Date)] üü¢ Server Active | Uptime: $uptime minutes | Status: Ready for connections"
              
              # Send periodic status updates to Telegram every hour
              if ($counter % 720 -eq 0) {  # Every 720 * 5 seconds = 1 hour
                  $botToken = "${{ secrets.TELEGRAM_BOT_TOKEN }}"
                  $chatId = "${{ secrets.TELEGRAM_CHAT_ID }}"
                  if ($botToken -and $chatId) {
                      try {
                          $statusMessage = "üü¢ **Server Status Update**`n`n" +
                                         "‚è∞ **Uptime:** $uptime minutes`n" +
                                         "üåê **IP:** ``$env:TAILSCALE_IP```n" +
                                         "üì± **BlueStacks:** Active`n" +
                                         "üéÆ **Status:** Ready for gaming!"
                          
                          $statusBody = @{
                              chat_id = $chatId
                              text = $statusMessage
                              parse_mode = "Markdown"
                          } | ConvertTo-Json
                          
                          Invoke-RestMethod -Uri "https://api.telegram.org/bot$botToken/sendMessage" `
                                          -Method POST -ContentType "application/json" -Body $statusBody
                      } catch {
                          # Silently continue if status update fails
                      }
                  }
              }
              
              Start-Sleep -Seconds 5
          }
